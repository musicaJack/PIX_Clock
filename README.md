# ESP32C3 DS3231 + SSD1306 NTP Timer

基于ESP32-C3的NTP时间同步时钟，使用DS3231 RTC模块和SSD1306 OLED显示屏。

## 功能特性

- ✅ 使用 DS3231 RTC 模块提供精确时间
- ✅ SSD1306 128x64 蓝黄双色OLED显示屏显示时间
- ✅ WiFi 配网功能（SoftAP 模式）
- ✅ NTP 时间同步（每 720 小时同步一次）
- ✅ 按键长按进入配网模式（GPIO3，长按3秒）
- ✅ 低功耗设计（WiFi 仅在需要时启用）
- ✅ DS3231 和 SSD1306 共用 I2C 总线

## 硬件连接

### ESP32-C3 引脚定义

```
ESP32C3:
  GPIO_0 (SDA) -> DS3231 SDA + SSD1306 SDA
  GPIO_1 (SCL) -> DS3231 SCL + SSD1306 SCL
  GPIO_3 (BUTTON) -> 按键（长按3秒进入配网模式）
```

### 模块说明

- **DS3231 RTC**: I2C地址 0x68（固定）
- **SSD1306 OLED**: I2C地址 0x3C（常见，如果不行可以尝试0x3D）
- **分辨率**: 128x64 像素
- **显示颜色**: 蓝黄双色（上半部分黄色，下半部分蓝色）

## 编译和烧录

```bash
# 设置ESP-IDF环境（如果还没有设置）
. $HOME/esp/esp-idf/export.sh

# 编译项目
idf.py build

# 烧录到设备
idf.py flash

# 查看串口输出
idf.py monitor
```

## WiFi 配网说明

### 首次使用

1. 设备上电后，如果没有保存的 WiFi 配置，会自动进入配网模式
2. 设备会创建一个名为 `VFD_Clock_Setup` 的 WiFi 热点，密码为 `12345678`
3. 使用手机或电脑连接到该热点
4. 打开浏览器，访问 `http://192.168.4.1`
5. 在配网页面输入您的 WiFi 名称（SSID）和密码
6. 点击"连接"按钮
7. 设备会自动保存配置并连接到您指定的 WiFi 网络
8. 连接成功后，设备会断开配网热点，并开始 NTP 时间同步

### 按键配网（推荐）

1. **长按 GPIO3 按键 3 秒**，设备会立即进入配网模式
2. **重要**：按键长按会**清除旧的 WiFi 配置**（强制重置），然后进入配网模式
3. 按照上述步骤 2-7 完成配网
4. **重要**：通过按键触发的配网，连接成功后会**强制进行 NTP 时间同步**（忽略 720 小时限制），确保时间准确
5. **注意**：按键长按检测在**任何时候**都有效，即使设备正在运行中也可以触发配网模式

### 自动重新配网

如果 WiFi 连接失败（5次重试都失败），设备会：
1. 自动清除旧的无效配置
2. 进入配网模式
3. 等待用户重新配置 WiFi

## 技术细节

### 系统初始化顺序
1. **NVS 初始化**：用于存储 WiFi 配置和同步时间戳
2. **时区设置**：在系统启动时立即设置时区（CST-8 UTC+8）
3. **硬件初始化**：I2C、DS3231、SSD1306 显示屏
4. **WiFi 配网模块初始化**
5. **NTP 同步需求检查**：基于时区设置计算时间差

### I2C 总线共享
- DS3231 和 SSD1306 使用同一个 I2C 总线实例
- 通过不同的 I2C 设备地址区分（DS3231: 0x68, SSD1306: 0x3C）
- I2C 总线配置：100kHz（DS3231），400kHz（SSD1306）

### WiFi 连接重试机制
- 最多重试 5 次
- 每次重试间隔 15 秒
- 第一次失败时自动扫描可用 WiFi 网络（用于诊断）
- 5 次都失败后自动清除配置并进入配网模式

### NTP 时间同步策略
- 默认：每 720 小时（30天）同步一次
- **重要优化**：如果不需要 NTP 同步（720小时内已同步），**不会启动 WiFi 模块**，节省功耗
- 按键配网：强制同步（忽略时间限制）
- 同步超时：60 秒
- 同步成功后自动更新 DS3231 RTC
- **时区处理**：
  - 系统启动时立即设置时区（CST-8 UTC+8）
  - 时区设置必须在检查 NTP 同步需求之前完成
  - 使用 `mktime()` 将 DS3231 本地时间转换为 UTC 时间戳时，依赖已设置的时区
  - 时间差计算基于 UTC 时间戳，确保准确性
  - NTP 同步后保存 UTC 时间戳到 NVS，用于后续时间差计算

### 低功耗设计
- **核心优化**：如果不需要 NTP 同步，WiFi 模块**完全不启动**，大幅降低功耗
- WiFi 仅在需要时启用（NTP 同步或配网时）
- 使用 DS3231 RTC 保持时间精度，无需 WiFi 即可正常工作
- NTP 同步完成后可关闭 WiFi（如果不需要持续连接）

### 按键功能
- **GPIO3 长按 3 秒**：在任何时候都可以触发配网模式
- 按键触发配网会**强制清除旧的 WiFi 配置**
- 按键触发配网成功后**强制进行 NTP 同步**（忽略 720 小时限制）
- 按键检测在主循环中持续运行，响应及时

## 项目结构

```
ESP32C3_ds3231_ssd1306/
├── CMakeLists.txt                    # 项目级CMakeLists
├── main/
│   ├── CMakeLists.txt                # main目录CMakeLists
│   ├── main.c                        # 主程序
│   └── lib/
│       ├── ds3231/                   # DS3231驱动
│       │   ├── ds3231.h
│       │   └── ds3231_driver.c
│       ├── ssd1306/                  # SSD1306驱动
│       │   ├── ssd1306.h
│       │   └── ssd1306.c
│       └── wifi_provisioning/        # WiFi配网模块
│           ├── wifi_provisioning.h
│           └── wifi_provisioning.c
└── sdkconfig                         # ESP-IDF配置文件
```

## 从Demo项目迁移

本项目是从 `demo/FutabaVFD_Display_ESP32_C3` 项目迁移而来，主要变更：

1. **显示模块**：从 FutabaVFD（SPI接口）替换为 SSD1306（I2C接口）
2. **I2C总线共享**：DS3231 和 SSD1306 共用 GPIO0/GPIO1
3. **移除SPI**：删除所有 SPI 相关代码和依赖
4. **功能保持**：所有其他功能完全保持不变（NTP同步、WiFi配网、按键功能等）

## 注意事项

1. **I2C地址**：如果SSD1306使用0x3C地址无法通信，可以尝试0x3D，修改 `main/main.c` 中的 `SSD1306_I2C_ADDR` 定义
2. **上拉电阻**：I2C总线已启用内部上拉，如果通信不稳定，建议添加外部上拉电阻（4.7kΩ）
3. **显示效果**：SSD1306显示时间格式为 `hh:mm:ss`，居中显示，使用2倍大小字体
4. **双色显示**：128x64蓝黄双色模块，上半部分（0-31行）为黄色，下半部分（32-63行）为蓝色

## 许可证

本项目基于demo项目迁移，保持相同的许可证。
