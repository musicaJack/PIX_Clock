# PIX_Clock - ESP32-C3 智能时钟
![License](https://img.shields.io/badge/license-MIT-blue.svg)
![Platform](https://img.shields.io/badge/platform-ESP32%20%20ESP32-brightgreen.svg)
![Version](https://img.shields.io/badge/version-1.0.0-orange.svg)

基于 ESP32-C3 的智能时钟项目，使用 DS3231 RTC 实时时钟模块和 SSD1306 OLED 显示屏，支持 WiFi 配网和 NTP 时间同步功能。

中文 | [English](README.md)

![Running Effect](imgs/demo1.png)
## ✨ 功能特性

### 核心功能
- ✅ **精确时间显示**：使用 DS3231 RTC 模块提供高精度时间（±2ppm 精度）
- ✅ **OLED 显示屏**：128x64 像素 SSD1306 OLED 显示屏，显示时间、日期、星期和温度
- ✅ **WiFi 配网**：支持 SoftAP 模式，通过 Web 界面轻松配置 WiFi
- ✅ **NTP 时间同步**：自动从网络同步时间，确保时间准确性
- ✅ **低功耗设计**：智能管理 WiFi 模块，仅在需要时启用
- ✅ **按键控制**：长按按键快速进入配网模式

### 显示特性
- **时间显示**：格式为 `HH:MM`，冒号每秒闪烁
- **日期显示**：格式为 `YYYY-MM-DD`
- **星期显示**：显示当前星期（Sun/Mon/Tue/Wed/Thu/Fri/Sat）
- **温度显示**：显示 DS3231 内置温度传感器读数（格式：`XX.Xc`）
- **自动亮度**：根据时间段自动调整显示亮度
  - 白天（06:00-17:59）：100% 亮度
  - 夜间（18:00-05:59）：75% 亮度
- **防烧屏**：每 5 分钟轻微移动显示位置，防止 OLED 烧屏

## 🔌 硬件连接

### ESP32-C3 引脚定义

| ESP32-C3 引脚 | 连接 | 说明 |
|--------------|------|------|
| GPIO0 | SDA | I2C 数据线（DS3231 + SSD1306） |
| GPIO1 | SCL | I2C 时钟线（DS3231 + SSD1306） |
| GPIO3 | BUTTON | 按键（长按 3 秒进入配网模式） |
| VBUS | TP4096 电池输入 | 从 TP4096 锂电池充电模块供电 |

### 模块规格

- **DS3231 RTC 模块**
  - I2C 地址：`0x68`（固定）
  - 精度：±2ppm（约 ±1 分钟/年）
  - 内置温度传感器
  - 备用电池支持（CR2032）

- **SSD1306 OLED 显示屏**
  - I2C 地址：`0x3C`（常见，自动尝试 `0x3D`）
  - 分辨率：128x64 像素
  - 显示类型：蓝黄双色（上半部分黄色，下半部分蓝色）

- **电源系统**
  - **TP4096 锂电池充电模块**
    - 电池输出：连接到 ESP32-C3 VBUS 引脚
    - 充电接口：面板上的 Type-C 接口（用于给锂电池充电）
    - 电池容量：850mAh 锂电池
    - 功能：为设备提供便携式电源供电

### 接线示意图

```
ESP32-C3          DS3231          SSD1306          TP4096
   GPIO0  ──────── SDA ──────────── SDA
   GPIO1  ──────── SCL ──────────── SCL
   GPIO3  ──────── BUTTON (按键)
   VBUS   ──────── 电池输出 (来自 TP4096)
   GND    ──────── GND ──────────── GND ──────────── GND
   3.3V   ──────── VCC ──────────── VCC

TP4096 模块：
   电池输出 ──── ESP32-C3 VBUS
   Type-C 接口 ── 面板 Type-C（用于充电）
   850mAh 电池 ── 连接到 TP4096
```

**注意**：
- I2C 总线已启用内部上拉电阻
- 如果通信不稳定，建议添加外部上拉电阻（4.7kΩ）
- DS3231 需要备用电池（CR2032）以保持断电后的时间
- **电源系统**：设备使用 TP4096 锂电池充电模块配合 850mAh 锂电池供电
  - ESP32-C3 VBUS 引脚连接到 TP4096 电池输出
  - 面板上的 Type-C 接口用于给锂电池充电
  - 设备可使用电池供电，实现便携式使用

## 🚀 编译和烧录

### 环境要求

- ESP-IDF v5.0 或更高版本
- CMake 3.16 或更高版本
- Python 3.6 或更高版本

### 编译步骤

```bash
# 设置 ESP-IDF 环境（如果还没有设置）
. $HOME/esp/esp-idf/export.sh
# Windows: .\esp-idf\export.bat

# 进入项目目录
cd PIX_Clock

# 配置项目（可选，使用默认配置）
idf.py menuconfig

# 编译项目
idf.py build

# 烧录到设备
idf.py flash

# 查看串口输出
idf.py monitor
# 或使用快捷键 Ctrl+] 退出 monitor
```

### 一键编译和烧录

```bash
idf.py flash monitor
```

## 📶 WiFi 配网说明

### 首次使用（自动配网）

1. 设备上电后，如果没有保存的 WiFi 配置，**会自动进入配网模式**
2. 设备会创建一个名为 `VFD_Clock_Setup` 的 WiFi 热点
3. 使用手机或电脑连接到该热点
   - **SSID**：`VFD_Clock_Setup`
   - **密码**：`12345678`
4. 打开浏览器，访问 `http://192.168.4.1`
5. 在配网页面输入您的 WiFi 信息：
   - WiFi 名称（SSID）
   - WiFi 密码
6. 点击"连接"按钮
7. 设备会自动保存配置并连接到您指定的 WiFi 网络
8. 连接成功后，设备会断开配网热点，并开始 NTP 时间同步

## ⏰ NTP 时间同步

### 同步策略

- **默认间隔**：每 720 小时（30 天）同步一次
- **智能判断**：如果 720 小时内已同步，**不会启动 WiFi 模块**，节省功耗
- **强制同步**：按键配网成功后强制同步（忽略时间限制）
- **同步超时**：60 秒内未同步成功则关闭 WiFi

### NTP 服务器

- 主服务器：`cn.pool.ntp.org`
- 备用服务器：`time.windows.com`
- 备用服务器：`pool.ntp.org`

### 时区设置

- 默认时区：**CST-8（UTC+8，北京时间）**
- 时区在系统启动时立即设置
- 所有时间显示和计算都基于本地时间

### 时间同步流程

1. 检查是否需要同步（基于上次同步时间戳）
2. 如果需要同步，启动 WiFi 并连接
3. WiFi 连接成功后，初始化 SNTP 客户端
4. 等待 NTP 服务器响应（最多 60 秒）
5. 同步成功后，更新 DS3231 RTC 时间
6. 保存同步时间戳到 NVS
7. 关闭 WiFi 以节省功耗

## 🔋 低功耗设计

### 功耗优化策略

1. **WiFi 智能管理**：
   - 仅在需要 NTP 同步或配网时启用 WiFi
   - 如果不需要同步（720 小时内已同步），WiFi 模块完全不启动
   - NTP 同步完成后立即关闭 WiFi

2. **DS3231 RTC 保持时间**：
   - 使用高精度 RTC 模块保持时间
   - 断电后由备用电池维持时间
   - 无需 WiFi 即可正常工作

3. **显示优化**：
   - 根据时间段自动调整亮度
   - 夜间降低亮度以节省功耗

## 🎛️ 按键功能

### GPIO3 按键

- **功能**：长按 3 秒进入配网模式
- **特性**：
  - 在任何时候都可以触发（主循环持续检测）
  - 触发后会清除旧的 WiFi 配置
  - 配网成功后会强制进行 NTP 同步
  - 响应及时，无需等待

### 按键检测机制

- 使用 GPIO 中断检测按键状态
- 在主循环中检测长按时间（3 秒）
- 支持上升沿和下降沿触发

## 📁 项目结构

```
PIX_Clock/
├── CMakeLists.txt                    # 项目级 CMakeLists
├── main/
│   ├── CMakeLists.txt                # main 目录 CMakeLists
│   ├── main.c                        # 主程序
│   └── lib/
│       ├── ds3231/                   # DS3231 驱动
│       │   ├── ds3231.h
│       │   └── ds3231_driver.c
│       ├── ssd1306/                  # SSD1306 驱动
│       │   ├── ssd1306.h
│       │   └── ssd1306.c
│       └── wifi_provisioning/        # WiFi 配网模块
│           ├── wifi_provisioning.h
│           └── wifi_provisioning.c
├── sdkconfig                         # ESP-IDF 配置文件
└── README.md                         # 项目说明文档
```

## 🔧 技术细节

### I2C 总线配置

- **总线共享**：DS3231 和 SSD1306 共用同一个 I2C 总线
- **设备地址**：
  - DS3231：`0x68`（固定）
  - SSD1306：`0x3C`（自动尝试 `0x3D`）
- **总线速度**：
  - DS3231：100kHz
  - SSD1306：400kHz
- **上拉电阻**：内部上拉已启用

### WiFi 连接重试机制

- **最大重试次数**：5 次
- **重试间隔**：15 秒
- **诊断功能**：第一次失败时自动扫描可用 WiFi 网络
- **失败处理**：5 次都失败后自动清除配置并进入配网模式

### NVS 存储

项目使用两个独立的 NVS 命名空间：

- **`wifi_config`**：存储 WiFi 配置（SSID 和密码）
- **`time_sync`**：存储上次 NTP 同步时间戳

命名空间隔离确保不会相互影响。

### 显示刷新机制

- **刷新频率**：每秒更新一次显示
- **时间读取**：从 DS3231 RTC 读取时间
- **显示内容**：时间、日期、星期、温度
- **像素位移**：每 5 分钟循环移动显示位置（8 个位置）

## ⚠️ 注意事项

1. **I2C 地址**：
   - 如果 SSD1306 使用 `0x3C` 地址无法通信，代码会自动尝试 `0x3D`
   - 如果两个地址都失败，系统会继续运行但不显示（串口会输出错误信息）

2. **上拉电阻**：
   - I2C 总线已启用内部上拉
   - 如果通信不稳定，建议添加外部上拉电阻（4.7kΩ）

3. **DS3231 备用电池**：
   - 建议安装 CR2032 备用电池
   - 备用电池可以保持断电后的时间
   - 如果没有备用电池，断电后时间会丢失

4. **WiFi 配置**：
   - WiFi 配置保存在 NVS 中，断电后不会丢失
   - 清除配置需要使用按键长按或重新配网

5. **时间同步**：
   - 首次使用需要配置 WiFi 才能同步时间
   - 如果 WiFi 未配置或连接失败，设备会使用 DS3231 的当前时间
   - 建议首次使用前手动设置 DS3231 时间（如果可能）

6. **显示效果**：
   - 128x64 蓝黄双色 OLED，上半部分（0-31 行）为黄色，下半部分（32-63 行）为蓝色
   - 时间使用 2 倍大小字体，居中显示
   - 日期、星期、温度使用 1 倍大小字体

## 🐛 故障排除

### 问题：无法连接到 WiFi

**解决方案**：
1. 检查 WiFi 名称和密码是否正确
2. 确认路由器支持 2.4GHz 频段（ESP32-C3 不支持 5GHz）
3. 检查路由器是否启用了 MAC 地址过滤
4. 查看串口输出的 WiFi 扫描结果，确认目标 SSID 是否在列表中

### 问题：时间显示不准确

**解决方案**：
1. 检查 DS3231 是否正常工作（查看串口日志）
2. 确认 WiFi 已连接并成功同步 NTP 时间
3. 检查时区设置是否正确（默认 UTC+8）
4. 如果长时间未同步，可以按键长按强制同步

### 问题：OLED 显示屏无显示

**解决方案**：
1. 检查 I2C 连接是否正确（SDA、SCL、GND、VCC）
2. 查看串口日志，确认 SSD1306 是否初始化成功
3. 尝试修改代码中的 I2C 地址（`0x3C` 或 `0x3D`）
4. 检查显示屏是否损坏（尝试其他 SSD1306 模块）

### 问题：按键无响应

**解决方案**：
1. 检查按键连接是否正确（GPIO3）
2. 确认按键按下时为低电平（代码中已启用上拉）
3. 检查按键是否损坏
4. 查看串口日志，确认 GPIO 初始化是否成功

## 📝 更新日志

### v1.0.0（当前版本）

- ✅ 实现 DS3231 RTC 时间读取和显示
- ✅ 实现 SSD1306 OLED 显示功能
- ✅ 实现 WiFi 配网功能（SoftAP 模式）
- ✅ 实现 NTP 时间同步功能
- ✅ 实现按键长按配网功能
- ✅ 实现自动亮度调节
- ✅ 实现像素位移防烧屏
- ✅ 实现低功耗设计（智能 WiFi 管理）

## 📄 许可证

本项目基于 ESP-IDF 开发，遵循相应的开源许可证。

## 🙏 致谢

- ESP-IDF 开发框架
- DS3231 RTC 模块
- SSD1306 OLED 显示屏

---

**项目名称**：PIX_Clock  
**硬件平台**：ESP32-C3  
**开发框架**：ESP-IDF v5.0+  
**最后更新**：2024
